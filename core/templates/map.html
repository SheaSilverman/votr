{% extends 'base.html' %}
{% load staticfiles %}

{% block content %}
    <!-- Page Heading -->
    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header">
                Dashboard <small>Voters Overview</small>
            </h1>
            <ol class="breadcrumb">
                <li class="active">
                    <i class="fa fa-dashboard"></i> Voters
                </li>
            </ol>
        </div>
    </div>
    <!-- /.row -->

    <div class="row">
        
        <div class="col-lg-12 map">
            <div class="well">


              <div id="map" style="height:1000px">TEST</div>
            </div>
        </div>
        
    </div>



    <!-- /.row -->
{% endblock %}


{% block js %}
    <link rel="stylesheet" href="{% static 'css/leaflet/MarkerCluster.css' %}" />
    <link rel="stylesheet" href="{% static 'css/leaflet/MarkerCluster.Default.css' %}" />

    <!-- Extra Markers -->
    <link rel="stylesheet" href="/dist/css/leaflet.extra-markers.min.css" />
    <script src="/dist/js/leaflet.extra-markers.min.js"></script>

    
    <script src="{% static 'js/leaflet/leaflet.markercluster.js' %}"></script>
    <script type="text/javascript">
        var addressPoints = [
                [28.581791, -81.24119, , "2"],
                [28.581791, -81.24119, , "3"],
                [28.581791, -81.24119, , "9"]
            ];

        var tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Points &copy 2012 LINZ'
            }),
        
        latlng = L.latLng(28.581791, -81.24119, );

        var map = L.map('map', {center: latlng, zoom: 13, layers: [tiles]});

        var markers = L.markerClusterGroup();
        
        for (var i = 0; i < addressPoints.length; i++) {
            var a = addressPoints[i];
            var title = a[2];
            var marker = L.marker(new L.LatLng(a[0], a[1]), { title: title });
            marker.bindPopup(title);
            markers.addLayer(marker);
        }

        map.addLayer(markers);
        


        map.on("moveend", function () {
          var markers = L.markerClusterGroup();
          // console.log(map.getCenter().toString());
          // console.log(map.getBounds()['_northEast']);
          // console.log(map.getBounds()['_southWest']);
          // console.log(map.getBounds().getEast());
          // console.log(map.getBounds().getWest());
          // console.log(map.getBounds().getNorth());
          // console.log(map.getBounds().getSouth());
          // console.log("select * from core_voter where latitude >=" + map.getBounds().getWest() + "  and latitude <=" + map.getBounds().getEast() + "  and longitude >=" + map.getBounds().getSouth() + "  and longitude <= " + map.getBounds().getNorth() + " ;");
          
          // Send the data using post
          var mapJSON = $.post( "/voter/voter_map/", { east: map.getBounds().getEast(), west: map.getBounds().getWest(), north: map.getBounds().getNorth(), south: map.getBounds().getSouth() } );
         
          // Put the results in a div
          mapJSON.done(function( data ) {
            //console.log(data[0]['fields']);

            for (var i = 0; i < data.length; i++) { 
              //console.log(data[i]['fields']['latitude'], data[i]['fields']['longitude']);
              var marker = L.marker(new L.LatLng(data[i]['fields']['longitude'], data[i]['fields']['latitude']), { title: "Boo" });
              marker.bindPopup(title);
              markers.addLayer(marker);
            }

            map.addLayer(markers);
            

            
            
            
          });
        });

          // var marker = L.marker(new L.LatLng(map.getBounds()['_northEast']['lat'], map.getBounds()['_northEast']['lng']), { title: "NorthEast" });
          // marker.bindPopup(title);
          // markers.addLayer(marker);

          // marker = L.marker(new L.LatLng(map.getBounds()['_southWest']['lat'], map.getBounds()['_southWest']['lng']), { title: "NorthEast" });
          // marker.bindPopup(title);
          // markers.addLayer(marker);
        

    </script>
{% endblock %}